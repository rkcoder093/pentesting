**Why Active Directory?**

Active Directory (AD) is a directory service for Windows network environments. It is a distributed, hierarchical structure that allows for centralized management of an organization's resources, including users, computers, groups, network devices, file shares, group policies, devices, and trusts. AD provides authentication and authorization functions within a Windows domain environment.

Active Directory makes information easy to find and use for administrators and users. AD is highly scalable, supports millions of objects per domain, and allows the creation of additional domains as an organization grows.

# Active Directory Structure

objects in AD
objects| objects
|-|-|
Domain Computers|	Domain Users
Domain Group Information	|Organizational Units (OUs)
Default Domain Policy|	Functional Domain Levels
Password Policy	|Group Policy Objects (GPOs)
Domain Trusts	|Access Control Lists (ACLs)

a very (simplistic) high level, an AD structure may look as follows:

    INLANEFREIGHT.LOCAL/
    ├── ADMIN.INLANEFREIGHT.LOCAL
    │   ├── GPOs
    │   └── OU
    │       └── EMPLOYEES
    │           ├── COMPUTERS
    │           │   └── FILE01
    │           ├── GROUPS
    │           │   └── HQ Staff
    │           └── USERS
    │               └── barbara.jones
    ├── CORP.INLANEFREIGHT.LOCAL
    └── DEV.INLANEFREIGHT.LOCAL

![DOMAINS](image.png)

![FOREST](image-1.png)

# Active Directory Terminology

**Object -** An object can be defined as ANY resource present within an Active Directory environment such as OUs, printers, users, domain controllers, etc.

**Attributes -** Every object in Active Directory has an associated set of attributes used to define characteristics of the given object. A computer object contains attributes such as the hostname and DNS name. All attributes in AD have an associated LDAP name that can be used when performing LDAP queries, such as displayName for Full Name and given name for First Name.

**Schema -** The Active Directory schema is essentially the blueprint of any enterprise environment. It defines what types of objects can exist in the AD database and their associated attributes.


**Domain -** A domain is a logical group of objects such as computers, users, OUs, groups, etc. We can think of each domain as a different city within a state or country. Domains can operate entirely independently of one another or be connected via trust relationships.

**Forest -** A forest is a collection of Active Directory domains. It is the topmost container and contains all of the AD objects introduced below, including but not limited to domains, users, groups, computers, and Group Policy objects. A forest can contain one or multiple domains

**Tree -** A tree is a collection of Active Directory domains that begins at a single root domain. A forest is a collection of AD trees. Each domain in a tree shares a boundary with the other domains. A parent-child trust relationship is formed when a domain is added under another domain in a tree. Two trees in the same forest cannot share a name (namespace). 

**Container** Container objects hold other objects and have a defined place in the directory subtree hierarchy.

**Leaf** Leaf objects do not contain other objects and are found at the end of the subtree hierarchy.

**Global Unique Identifier (GUID)** This GUID value is unique across the enterprise, similar to a MAC address. Every single object created by Active Directory is assigned a GUID, not only user and group objects. The GUID is stored in the ObjectGUID attribute. Specifying the ObjectGUID value when performing AD enumeration will ensure that we get the most accurate results pertaining to the object we are searching for information about. The ObjectGUID property never changes and is associated with the object for as long as that object exists in the domain.

**Security principals** Security principals are anything that the operating system can authenticate, including users, computer accounts, or even threads/processes that run in the context of a user or computer account 

**Security Identifier (SID)** A security identifier, or SID is used as a unique identifier for a security principal or security group. Every account, group, or process has its own unique SID, which, in an AD environment, is issued by the domain controller and stored in a secure database.


**Distinguished Name (DN)** A Distinguished Name (DN) describes the full path to an object in AD 

**Relative Distinguished Name (RDN)** A Relative Distinguished Name (RDN) is a single component of the Distinguished Name that identifies the object as unique from other objects at the current level in the naming hierarchy.

**sAMAccountName** The sAMAccountName is the user's logon name. Here it would just be bjones. It must be a unique value and 20 or fewer characters.

**userPrincipalName** The userPrincipalName attribute is another way to identify users in AD. This attribute consists of a prefix (the user account name) and a suffix (the domain name) in the format of bjones@inlanefreight.local. This attribute is not mandatory.

**FSMO Role**
These give Domain Controllers (DC) the ability to continue authenticating users and granting permissions without interruption (authorization and authentication). FSMO roles: Schema Master and Domain Naming Master (one of each per forest), Relative ID (RID) Master (one per domain), Primary Domain Controller (PDC) Emulator (one per domain), and Infrastructure Master (one per domain).


**Global Catalog**
A global catalog (GC) is a domain controller that stores copies of ALL objects in an Active Directory forest. The GC stores a full copy of all objects in the current domain and a partial copy of objects that belong to other domains in the forest

**Read-Only Domain Controller (RODC)**
A Read-Only Domain Controller (RODC) has a read-only Active Directory database. 

**Replication**
Replication happens in AD when AD objects are updated and transferred from one Domain Controller to another. 

**Service Principal Name (SPN)**
A Service Principal Name (SPN) uniquely identifies a service instance. They are used by Kerberos authentication to associate an instance of a service with a logon account, allowing a client application to request the service to authenticate an account without needing to know the account name.

**Group Policy Object (GPO)**
Group Policy Objects (GPOs) are virtual collections of policy settings. Each GPO has a unique GUID. A GPO can contain local file system settings or Active Directory settings. GPO settings can be applied to both user and computer objects. 

Access Control List (ACL) is the ordered collection of Access Control Entries (ACEs) that apply to an object.

Access Control Entry (ACE) in an ACL identifies a trustee (user account, group account, or logon session) and lists the access rights that are allowed, denied, or audited for the given trustee.

DACLs define which security principles are granted or denied access to an object; it contains a list of ACEs.  If an object does NOT have a DACL, then the system will grant full access to everyone, but if the DACL has no ACE entries, the system will deny all access attempts. 

System Access Control Lists (SACL)
Allows for administrators to log access attempts that are made to secured objects. ACEs specify the types of access attempts that cause the system to generate a record in the security event log.

Fullly qualified domain name [host name].[domain name].[tld]. 

tombstone is a container object in AD that holds deleted AD objects. When an object is deleted from AD, the object remains for a set period of time known as the Tombstone Lifetime,   If an object is deleted in a domain that does not have an AD Recycle Bin, it will become a tombstone object. When this happens, the object is stripped of most of its attributes and placed in the Deleted Objects container for the duration of the tombstoneLifetime. It can be recovered, but any attributes that were lost can no longer be recovered.

This made it easier for sysadmins to restore objects, avoiding the need to restore from backups, restarting Active Directory Domain Services (AD DS), or rebooting a Domain Controller

SYSVOL folder, or share, stores copies of public files in the domain such as system policies, Group Policy settings, logon/logoff scripts, and often contains other types of scripts that are executed to perform various tasks in the AD environment.


## AD Objects
![Objects](image.png)

users, computers, printers, contacts are leaf objects.

Groups
A group is considered a container object because it can contain other objects, including users, computers, and even other groups.

Organizational Units (OUs)
An organizational unit, or OU from here on out, is a container that systems administrators can use to store similar objects for ease of administration. 

Domain
A domain is the structure of an AD network. Domains contain objects such as users and computers, which are organized into container objects: groups and OUs. Every domain has its own separate database and sets of policies that can be applied to any and all objects within the domain.

Domain Controllers
Domain Controllers are essentially the brains of an AD network. They handle authentication requests, verify users on the network, and control who can access the various resources in the domain. 

Foreign Security Principals
A foreign security principal (FSP) is an object created in AD to represent a security principal that belongs to a trusted external forest.

## Five Flexible Single Master Operation (FSMO) roles

|Roles|	Description
|-|-|
|Schema Master|	This role manages the read/write copy of the AD schema, which defines all attributes that can apply to an object in AD.
|Domain Naming Master|	Manages domain names and ensures that two domains of the same name are not created in the same forest.
|Relative ID (RID) Master|	The RID Master assigns blocks of RIDs to other DCs within the domain that can be used for new objects. The RID Master helps ensure that multiple objects are not assigned the same SID. Domain object SIDs are the domain SID combined with the RID number assigned to the object to make the unique SID.
|PDC Emulator|	The host with this role would be the authoritative DC in the domain and respond to authentication requests, password changes, and manage Group Policy Objects (GPOs). The PDC Emulator also maintains time within the domain.
|Infrastructure Master|	This role translates GUIDs, SIDs, and DNs between domains. This role is used in organizations with multiple domains in a single forest. The Infrastructure Master helps them to communicate. If this role is not functioning properly, Access Control Lists (ACLs) will show SIDs instead of fully resolved names.


Trusts
A trust is used to establish forest-forest or domain-domain authentication, allowing users to access resources in (or administer) another domain outside of the domain their account resides in. A trust creates a link between the authentication systems of two domains.

Trust Type	Description
Parent-child	Domains within the same forest. The child domain has a two-way transitive trust with the parent domain.
Cross-link	a trust between child domains to speed up authentication.
External	A non-transitive trust between two separate domains in separate forests which are not already joined by a forest trust. This type of trust utilizes SID filtering.
Tree-root	a two-way transitive trust between a forest root domain and a new tree root domain. They are created by design when you set up a new tree root domain within a forest.
Forest	a transitive trust between two forest root domains.


Trusts can be transitive or non-transitive.

- A transitive trust means that trust is extended to objects that the child domain trusts.

- In a non-transitive trust, only the child domain itself is trusted.

Trusts can be set up to be one-way or two-way (bidirectional).

- In bidirectional trusts, users from both trusting domains can access resources.
- In a one-way trust, only users in a trusted domain can access resources in a trusting domain, not vice-versa. The direction of trust is opposite to the direction of access.


![kerberos](image-1.png)

*The Kerberos protocol uses port 88 (both TCP and UDP).*

![DNS](image-2.png)

*DNS uses TCP and UDP port 53. UDP port 53 is the default, but it falls back to TCP when no longer able to communicate and DNS messages are larger than 512 bytes.*

Forward DNS Lookup - `nslookup INLANEFREIGHT.LOCAL`
Reverse DNS Lookup - `nslookup 172.16.6.5`
Finding IP Address of a Host - `nslookup ACADEMY-EA-DC01`

![LDAP](image-3.png)

*LDAP uses port 389, and LDAP over SSL (LDAPS) communicates over port 636.  *


    